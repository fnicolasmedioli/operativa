<!DOCTYPE html>
<html>

<head>
    <style>
        body {
            margin: 0;
        }
    </style>

    <script src="
https://cdn.jsdelivr.net/npm/force-graph@1.49.1/dist/force-graph.min.js
"></script>
    <link href="
https://cdn.jsdelivr.net/npm/force-graph@1.49.1/src/force-graph.min.css
" rel="stylesheet">
</head>

<body>
    <div id="graph"></div>

    <script>
        // Random tree
        const N = 300;
        const gData = {"nodes":[{"id":"181","text":"cs_compu_1 AND discreta","esIntermedio":true},{"id":"255","text":"cs_compu_1 AND prog_2","esIntermedio":true},{"id":"351","text":"prog_1 AND algebra_1 AND cs_compu_1","esIntermedio":true},{"id":"431","text":"cs_compu_1 AND prog_2 AND discreta","esIntermedio":true},{"id":"522","text":"algebra_1 AND prog_2","esIntermedio":true},{"id":"608","text":"algebra_1 AND cs_compu_1 AND prog_2","esIntermedio":true},{"id":"690","text":"algebra_1 AND prog_2","esIntermedio":true},{"id":"697","text":"algebra_1 AND cs_compu_1","esIntermedio":true},{"id":"708","text":"prog_2 AND discreta","esIntermedio":true},{"id":"726","text":"prog_1 AND cs_compu_1","esIntermedio":true},{"id":"788","text":"cs_compu_1 AND prog_2","esIntermedio":true},{"id":"863","text":"prog_2 AND discreta","esIntermedio":true},{"id":"1047","text":"algebra_1 AND prog_2","esIntermedio":true},{"id":"1219","text":"prog_2 AND discreta","esIntermedio":true},{"id":"1230","text":"algebra_1 AND cs_compu_1","esIntermedio":true},{"id":"1268","text":"cs_compu_1 AND prog_2","esIntermedio":true},{"id":"1365","text":"algebra_1 AND prog_2","esIntermedio":true},{"id":"1393","text":"prog_2 AND discreta","esIntermedio":true},{"id":"1963","text":"prog_1 AND algebra_1","esIntermedio":true},{"id":"2371","text":"algebra_1 AND cs_compu_1 AND prog_2","esIntermedio":true},{"id":"2494","text":"cs_compu_1 AND prog_2 AND discreta","esIntermedio":true},{"id":"2750","text":"cs_compu_1 AND discreta","esIntermedio":true},{"id":"2788","text":"algebra_1 AND cs_compu_1","esIntermedio":true},{"id":"2911","text":"cs_compu_1 AND prog_2","esIntermedio":true},{"id":"2936","text":"prog_2 AND discreta","esIntermedio":true},{"id":"2940","text":"cs_compu_1 AND prog_2","esIntermedio":true},{"id":"2946","text":"algebra_1 AND cs_compu_1","esIntermedio":true},{"id":"2958","text":"algebra_1 AND cs_compu_1 AND prog_2","esIntermedio":true},{"id":"6111","text":"prog_1","esIntermedio":false},{"id":"6113","text":"algebra_1","esIntermedio":false},{"id":"6121","text":"cs_compu_1","esIntermedio":false},{"id":"6122","text":"prog_2","esIntermedio":false},{"id":"6125","text":"discreta","esIntermedio":false},{"id":"0000","text":"inicio","esIntermedio":true}],"links":[{"source":"181","target":"6121","value":"Pa(cs_compu_1)"},{"source":"181","target":"6125","value":"Pa(discreta)"},{"source":"255","target":"6121","value":"Pa(cs_compu_1)"},{"source":"255","target":"6122","value":"Pa(prog_2)"},{"source":"351","target":"255","value":"Pa(prog_1)"},{"source":"351","target":"351","curvature":1},{"source":"351","target":"431","value":"Pa(algebra_1)"},{"source":"351","target":"1230","value":"Pa(prog_1)"},{"source":"351","target":"1268","value":"Pa(algebra_1)"},{"source":"351","target":"1365","value":"Pa(prog_1)"},{"source":"351","target":"1393","value":"Pa(cs_compu_1)"},{"source":"351","target":"2750","value":"Pa(algebra_1)"},{"source":"351","target":"2936","value":"Pa(algebra_1)"},{"source":"351","target":"2958","value":"Pa(prog_1)"},{"source":"431","target":"6121","value":"Pa(cs_compu_1)"},{"source":"431","target":"6122","value":"Pa(prog_2)"},{"source":"431","target":"6125","value":"Pa(discreta)"},{"source":"522","target":"6113","value":"Pa(algebra_1)"},{"source":"522","target":"6122","value":"Pa(prog_2)"},{"source":"608","target":"6113","value":"Pa(algebra_1)"},{"source":"608","target":"6121","value":"Pa(cs_compu_1)"},{"source":"608","target":"6122","value":"Pa(prog_2)"},{"source":"690","target":"6113","value":"Pa(algebra_1)"},{"source":"690","target":"6122","value":"Pa(prog_2)"},{"source":"697","target":"6113","value":"Pa(algebra_1)"},{"source":"697","target":"6121","value":"Pa(cs_compu_1)"},{"source":"708","target":"6122","value":"Pa(prog_2)"},{"source":"708","target":"6125","value":"Pa(discreta)"},{"source":"726","target":"522","value":"Pa(prog_1)"},{"source":"726","target":"608","value":"Pa(prog_1)"},{"source":"726","target":"726","curvature":1},{"source":"726","target":"1047","value":"Pa(cs_compu_1)"},{"source":"726","target":"2788","value":"Pa(prog_1)"},{"source":"726","target":"2940","value":"Pa(prog_1)"},{"source":"788","target":"6121","value":"Pa(cs_compu_1)"},{"source":"788","target":"6122","value":"Pa(prog_2)"},{"source":"863","target":"6122","value":"Pa(prog_2)"},{"source":"863","target":"6125","value":"Pa(discreta)"},{"source":"1047","target":"6113","value":"Pa(algebra_1)"},{"source":"1047","target":"6122","value":"Pa(prog_2)"},{"source":"1219","target":"6122","value":"Pa(prog_2)"},{"source":"1219","target":"6125","value":"Pa(discreta)"},{"source":"1230","target":"6113","value":"Pa(algebra_1)"},{"source":"1230","target":"6121","value":"Pa(cs_compu_1)"},{"source":"1268","target":"6121","value":"Pa(cs_compu_1)"},{"source":"1268","target":"6122","value":"Pa(prog_2)"},{"source":"1365","target":"6113","value":"Pa(algebra_1)"},{"source":"1365","target":"6122","value":"Pa(prog_2)"},{"source":"1393","target":"6122","value":"Pa(prog_2)"},{"source":"1393","target":"6125","value":"Pa(discreta)"},{"source":"1963","target":"181","value":"Pa(algebra_1)"},{"source":"1963","target":"690","value":"Pa(prog_1)"},{"source":"1963","target":"697","value":"Pa(prog_1)"},{"source":"1963","target":"708","value":"Pa(algebra_1)"},{"source":"1963","target":"788","value":"Pa(algebra_1)"},{"source":"1963","target":"1963","curvature":1},{"source":"1963","target":"2371","value":"Pa(prog_1)"},{"source":"1963","target":"2494","value":"Pa(algebra_1)"},{"source":"1963","target":"2911","value":"Pa(prog_1)"},{"source":"2371","target":"6113","value":"Pa(algebra_1)"},{"source":"2371","target":"6121","value":"Pa(cs_compu_1)"},{"source":"2371","target":"6122","value":"Pa(prog_2)"},{"source":"2494","target":"6121","value":"Pa(cs_compu_1)"},{"source":"2494","target":"6122","value":"Pa(prog_2)"},{"source":"2494","target":"6125","value":"Pa(discreta)"},{"source":"2750","target":"6121","value":"Pa(cs_compu_1)"},{"source":"2750","target":"6125","value":"Pa(discreta)"},{"source":"2788","target":"6113","value":"Pa(algebra_1)"},{"source":"2788","target":"6121","value":"Pa(cs_compu_1)"},{"source":"2911","target":"6121","value":"Pa(cs_compu_1)"},{"source":"2911","target":"6122","value":"Pa(prog_2)"},{"source":"2936","target":"6122","value":"Pa(prog_2)"},{"source":"2936","target":"6125","value":"Pa(discreta)"},{"source":"2940","target":"6121","value":"Pa(cs_compu_1)"},{"source":"2940","target":"6122","value":"Pa(prog_2)"},{"source":"2946","target":"863","value":"Pa(cs_compu_1)"},{"source":"2946","target":"1219","value":"Pa(algebra_1)"},{"source":"2946","target":"2946","curvature":1},{"source":"2958","target":"6113","value":"Pa(algebra_1)"},{"source":"2958","target":"6121","value":"Pa(cs_compu_1)"},{"source":"2958","target":"6122","value":"Pa(prog_2)"},{"source":"0000","target":"351","value":"Pa(inicio)"},{"source":"0000","target":"726","value":"Pa(inicio)"},{"source":"0000","target":"1963","value":"Pa(inicio)"},{"source":"0000","target":"2946","value":"Pa(inicio)"},{"source":"0000","target":"6111","value":"Pa(inicio)"},{"source":"0000","target":"6113","value":"Pa(inicio)"},{"source":"0000","target":"6121","value":"Pa(inicio)"}]}










        // cross-link node objects
        gData.links.forEach(link => {
            const a = gData.nodes.find(node => node.id === link.source);
            const b = gData.nodes.find(node => node.id === link.target);

            if (!a || !b) {
                console.warn("Nodo no encontrado para el enlace:", link);
                return;
            }

            !a.neighbors && (a.neighbors = []);
            !b.neighbors && (b.neighbors = []);
            a.neighbors.push(b);
            b.neighbors.push(a);

            !a.links && (a.links = []);
            !b.links && (b.links = []);
            a.links.push(link);
            b.links.push(link);
        });

        const NODE_R = 8;

        const highlightNodes = new Set();
        const highlightLinks = new Set();
        let hoverNode = null;

        const Graph = new ForceGraph(document.getElementById('graph'))
            .graphData(gData)
            .nodeRelSize(NODE_R)
            .nodeId('id')
            .onLinkHover(link => {
                highlightNodes.clear();
                highlightLinks.clear();
                if (link) {
                    highlightLinks.add(link);
                    highlightNodes.add(link.source);
                    highlightNodes.add(link.target);
                }
            })
            .autoPauseRedraw(false) // keep redrawing after engine has stopped
            .linkWidth(link => highlightLinks.has(link) ? 5 : 1)
            .linkDirectionalParticles(4)
            .linkDirectionalParticleWidth(link => highlightLinks.has(link) ? 4 : 0)
            .linkCurvature('curvature')
            .linkCanvasObjectMode(() => 'after')
            .linkCanvasObject((link, ctx) => {
                const MAX_FONT_SIZE = 4;
                const LABEL_NODE_MARGIN = Graph.nodeRelSize() * 1.5;

                const start = link.source;
                const end = link.target;
                if (typeof start !== 'object' || typeof end !== 'object') return;

                const textPos = { x: start.x + (end.x - start.x) / 2, y: start.y + (end.y - start.y) / 2 };
                const relLink = { x: end.x - start.x, y: end.y - start.y };
                const maxTextLength = Math.sqrt(relLink.x ** 2 + relLink.y ** 2) - LABEL_NODE_MARGIN * 2;

                let textAngle = Math.atan2(relLink.y, relLink.x);
                if (textAngle > Math.PI / 2) textAngle = -(Math.PI - textAngle);
                if (textAngle < -Math.PI / 2) textAngle = -(-Math.PI - textAngle);

                const label = link.value;
                ctx.font = '1px Sans-Serif';
                const fontSize = Math.min(MAX_FONT_SIZE, maxTextLength / ctx.measureText(label).width);
                ctx.font = `${fontSize}px Sans-Serif`;
                const textWidth = ctx.measureText(label).width;
                const bckgDimensions = [textWidth, fontSize].map(n => n + fontSize * 0.2);

                ctx.save();
                ctx.translate(textPos.x, textPos.y);
                ctx.rotate(textAngle);

                // Cambiar estilo si el link está resaltado
                if (highlightLinks.has(link)) {
                    ctx.fillStyle = 'rgba(255, 200, 100, 1)'; // Fondo más llamativo
                    ctx.fillRect(-bckgDimensions[0] / 2, -bckgDimensions[1] / 2, ...bckgDimensions);
                    ctx.fillStyle = 'black'; // Texto en negro
                    ctx.font = `bold ${fontSize}px Sans-Serif`; // Negrita
                } else {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)'; // Fondo normal
                    ctx.fillRect(-bckgDimensions[0] / 2, -bckgDimensions[1] / 2, ...bckgDimensions);
                    ctx.fillStyle = 'darkgrey'; // Texto gris
                }

                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(label, 0, 0);
                ctx.restore();
            })
            .nodeCanvasObjectMode(node => highlightNodes.has(node) ? 'before' : 'after')
            .nodeCanvasObject((node, ctx, globalScale) => {
                if (highlightNodes.has(node)) {
                    // Dibujar anillo de hover antes del nodo
                    ctx.beginPath();
                    ctx.arc(node.x, node.y, NODE_R * 1.4, 0, 2 * Math.PI, false);
                    ctx.fillStyle = node === hoverNode ? 'red' : 'orange';
                    ctx.fill();
                }

                // Dibujar el nodo principal
                ctx.beginPath();
                ctx.arc(node.x, node.y, NODE_R, 0, 2 * Math.PI, false);
                ctx.fillStyle = node.color || 'blue';
                ctx.fill();

                // Mostrar label solo si el nodo está en hover o resaltado
                if (highlightNodes.has(node) || node === hoverNode) {
                    const label = node.text || node.id;
                    const fontSize = Math.max(12 / globalScale, 4);
                    ctx.font = `${fontSize}px Sans-Serif`;
                    const textWidth = ctx.measureText(label).width;
                    const bckgDimensions = [textWidth, fontSize].map(n => n + fontSize * 0.2);

                    // Dibujar fondo del label
                    ctx.fillStyle = node.esIntermedio ? 'rgba(100, 255, 100, 0.8)' : 'rgba(255, 255, 255, 0.8)';
                    ctx.fillRect(node.x - bckgDimensions[0] / 2, node.y - NODE_R - bckgDimensions[1], ...bckgDimensions);

                    // Dibujar texto del label
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = "#000";
                    ctx.fillText(label, node.x, node.y - NODE_R - bckgDimensions[1] / 2);
                }
            })
            .nodePointerAreaPaint((node, color, ctx) => {
                // Define la zona de detección del nodo
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(node.x, node.y, NODE_R * 1.5, 0, 2 * Math.PI, false);
                ctx.fill();
            })
            .onNodeHover(node => {
                highlightNodes.clear();
                highlightLinks.clear();

                if (node) {
                    highlightNodes.add(node);
                    node.neighbors.forEach(neighbor => highlightNodes.add(neighbor));
                    node.links.forEach(link => highlightLinks.add(link));
                }

                hoverNode = node || null;
            })
            .onNodeDragEnd(node => {
                node.fx = node.x;
                node.fy = node.y;
            });

    </script>
</body>